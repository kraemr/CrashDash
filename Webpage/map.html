<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="style.css">

    
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha384-VzLXTJGPSyTLX6d96AxgkKvE/LRb7ECGyTxuwtpjHnVWVZs2gp5RDjeM/tgBnVdM"
      crossorigin="anonymous"
    />
 
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css"
      integrity="sha384-wgw+aLYNQ7dlhK47ZPK7FRACiq7ROZwgFNg0m04avm4CaXS+Z9Y7nMu8yNjBKYC+"
      crossorigin="anonymous"
    />
    
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha384-RFZC58YeKApoNsIbBxf4z6JJXmh+geBSgkCQXFyh+4tiFSJmJBt+2FbjxW7Ar16M"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"
      integrity="sha384-89yDmbSkL9reFc77m10ZbqLaUMf1sp7FAJs2oAD/rczNnY7I+17yN9KML6tpYpCk"
      crossorigin="anonymous"
    ></script>

</head>
<body>
  <div class="navbar">
    <div class="logo">
      <a href="home.html">
          <img src="img/logo.jpg" alt="logo">
      </a>
  </div>
    <ul class="nav-menu">
      <li><a href="home.html">Home</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="map.html">Map</a></li>
      <li><a href="table-view.html">Table-View</a></li>
    </ul>
  </div>

  <div class="content">
      <div style="display: flex; justify-content: space-between; gap: 64px;">

        <div class="map-menu">
          <h3>Nach Bundesland/Stadt filtern:</h3>
           
          <div>
            <p>Bundesland auswählen:</p>
            <select id="region">
              <option value="1">Schleswig-Holstein (SH)</option>
              <option value="2">Hamburg (HH)</option>
              <option value="3">Niedersachsen (NI)</option>
              <option value="4">Bremen (HB)</option>
              <option value="5">Nordrhein-Westfalen (NW)</option>
              <option value="6">Hessen (HE)</option>
              <option value="7">Rheinland-Pfalz (RP)</option>
              <option value="8">Baden-Württemberg (BW)</option>
              <option value="9">Bayern (BY)</option>
              <option value="10">Saarland (SL)</option>
              <option value="11">Berlin (BE)</option>
              <option value="12">Brandenburg (BB)</option>
              <option value="13">Mecklenburg-Vorpommern (MV)</option>
              <option value="14">Sachsen (SN)</option>
              <option value="15">Sachsen-Anhalt (ST)</option>
              <option value="16">Thüringen (TH)</option>
            </select> 
            
          </div>


          <div>
            <p>Unfall-Ausgang:</p>
            <select id="kind">
              <option value="1">Zusammenstoß mit anfahrendem/anhaltendem/ruhendem Fahrzeug</option>
              <option value="2">Zusammenstoß mit vorausfahrendem / wartendem Fahrzeug</option>
              <option value="3">Zusammenstoß mit seitlich in gleicher Richtung fahrendem Fahrzeug</option>
              <option value="4">Zusammenstoß mit entgegenkommendem Fahrzeug</option>
              <option value="5">Zusammenstoß mit einbiegendem / kreuzendem Fahrzeug</option>
              <option value="6">Zusammenstoß zwischen Fahrzeug und Fußgänger</option>
              <option value="7">Aufprall auf Fahrbahnhindernis</option>
              <option value="8">Abkommen von Fahrbahn nach rechts</option>
              <option value="9">Abkommen von Fahrbahn nach links</option>
              <option value="0">Unfall anderer Art</option>
              <option value="-1">Kein Filter</option>

            </select> 
          </div>


            

          <div>
            <p>oder erweiterten Filter benutzen</p>
            <div class="centered-HBox">
              <input type="text" id="search-filter" placeholder="Stadt/Bezirk/Straße" value="Mainz">
            </div>
          </div>

          
          <div>
            <p>Jahr:</p>
            <select id="year">
              <option value="2022" selected>2022</option>
              <option value="2021">2021</option>
              <option value="2020">2020</option>
              <option value="2019">2019</option>
              <option value="2018">2018</option>
              <option value="2017">2017</option>
              <option value="2016">2016</option>
            </select> 
          </div>
          
          <button onclick="search(true)">Filtern</button>
          
          <br><h3>Weitere Filteroptionen:</h3>
          <div>
            <div class="leftSided-HBox">
              <p>Unfall mit Personenschaden</p>
              <div class="checkbox-wrapper">
                <input class="toggleBox toggleBox-skewed" id="ctb1" type="checkbox" checked/>
                <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb1"></label>
              </div>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit Todesfolge</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb2" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb2"></label>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit PKW-Beteiligung</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb3" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb3"></label>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit Güter-KFZ-Beteiligung</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb4" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb4"></label>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit Kraftrad-Beteiligung</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb5" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb5"></label>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit Fahrrad-Beteiligung</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb6" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb6"></label>
            </div>
          </div>

          <div class="leftSided-HBox">
            <p>Unfall mit Fußgänger-Beteiligung</p>
            <div class="checkbox-wrapper">
              <input class="toggleBox toggleBox-skewed" id="ctb7" type="checkbox"/>
              <label class="toggleBox-btn" data-tg-off="aus" data-tg-on="an" for="ctb7"></label>
            </div>
          </div>

          <button style="margin-top: 32px;" class="warning-btn" onclick="resetFilter()">Filter zurücksetzen</button> 
        </div>
        <div class="mapDiv">
          <div id="map" style="height: calc(100vh - 175px); position: inherit; border-radius: 16px; z-index: 1;"></div>
          </div>   
      </div>

  </div>  
</body>

<script>
  var lMap = L.map('map').setView([49.9648157, 8.2397071], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    minZoom: 6,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
  }).addTo(lMap);

  // Gruppe für die Marker erstellen
  var markers = L.markerClusterGroup().addTo(lMap);

  // Erstellen Sie eine LayerGroup
  var geojsonLayer = L.layerGroup().addTo(lMap);

  // Todo: ggf. auf Nominatim wechseln (falls wir das echt benutzen)
  fetch('geojson/countries.geojson')
    .then(response => response.json())
    .then(data => {
        L.geoJSON(data, {
            style: function(feature) {
                // Alle Länder außer Deutschland grau färben
                if (feature.properties.name !== "Germany") {
                    return {
                      fillColor: '#333',
                      fillOpacity: 0.15,
                      color: 'transparent'
                    };
                }
                else {
                    return {
                      fillColor: 'transparent',
                      fillOpacity: 0.0,
                      color: '#3296FF',
                      weight: 2
                    };
                }
            }
        }).addTo(lMap);
  }).catch(error => console.error(error));

  // Globale Variable für den GeoJSON-Layer
  var geojsonLayer;
  resetFilter();
  search(true);
  function search(areaChanged) {
    // Alle Marker entfernen -> todo: könnte man optimieren
    markers.clearLayers();


    // Marker aus output.json laden
    var jsonMarkers = [];
    let year = document.getElementById("year").value;
    let land = document.getElementById("region").value;// bundesland
    let kind = document.getElementById("kind").value;// bundesland
    console.log("bundesland: " + document.getElementById("region").value);
    let xhr = new XMLHttpRequest();
    xhr.open("GET", "../php/map-api.php?year="+year+"&land="+land+"&kind="+kind, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        let data = JSON.parse(xhr.responseText);
        data.forEach(element => {
          var m = L.marker([element.latitude, element.longitude]);
          var href = "details.html?id=" + element.ID;
          var popupContent = "<a href='" + href + "'>" + "Mehr Informationen anzeigen" + "</a>";
          m.bindPopup(popupContent).openPopup();

          markers.addLayer(m);

        }); //foreach 
      } // if xhr ready
    };// xhr call back
    xhr.send();
  
    if (areaChanged) {
      // Alte GeoJSON entfernen
      if (geojsonLayer != null) {
        lMap.removeLayer(geojsonLayer);
      }

      var query = document.getElementById("search-filter").value;
      var cityUrl = "https://nominatim.openstreetmap.org/search.php?q=" + query + "&polygon_geojson=1&format=geojson&limit=1&countrycodes=de";
      fetch(cityUrl)
        .then(response => response.json())
        .then(data => {
        var bounds = L.geoJSON(data).getBounds();  
        lMap.fitBounds(bounds);
        // Alle Marker die nicht in der Grenze liegen entfernen
        markers.eachLayer(function (marker) {
          if (!bounds.contains(marker.getLatLng())) {
            markers.removeLayer(marker);
          }
        });

        geojsonLayer = L.geoJSON(data, {
        style: function(feature) {
            return {
                fillColor: '#3296FF',
                fillOpacity: 0.1,
                color: '#3296FF',
                weight: 2
            };
        }
        }).addTo(lMap); 

      }).catch(error => console.error(error));
  }}

  function changeYear(){
    var year = document.getElementById("year").value;
    var land = document.getElementById("region").value;// bundesland
    var kind = document.getElementById("kind").value;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "../php/map-api.php?year="+year+"&land="+land, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = JSON.parse(xhr.responseText);
        data.forEach(element => {
          var m = L.marker([element.latitude, element.longitude]);
          markers.addLayer(m);
        }); //foreach 
      } // if xhr ready
    };// xhr call back
    xhr.send();
  
  }

  function resetFilter() {
    document.getElementById("region").value = 7;
    document.getElementById("search-filter").value = "Mainz";
    document.getElementById("year").value = "2022";
    document.getElementById("kind").value = "";
    document.getElementById("ctb1").checked = false;
    document.getElementById("ctb2").checked = false;
    document.getElementById("ctb3").checked = false;
    document.getElementById("ctb4").checked = false;
    document.getElementById("ctb5").checked = false;
    document.getElementById("ctb6").checked = false;
    document.getElementById("ctb7").checked = false;
    search(true);
  }

  /*

  // On-Change-Listener für die Checkboxen und die Select-Box hinzufügen
  document.getElementById("ctb1").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb2").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb3").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb4").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb5").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb6").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("ctb7").addEventListener("change", function() {
    search(false);
  });
  document.getElementById("year").addEventListener("change", function() {
    changeYear();
  });

  document.getElementById("region").addEventListener("change", function() {
    search(true);
  });
  */
  
</script>
</html>
