<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Web-Anwendung</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
</head>
<body>
	<div id="mapid" style="height: 500px;"></div>
	<input type="text" id="search-box" placeholder="Ort suchen">
	<button onclick="search()">Suchen</button>
	<script>
		var mymap = L.map('mapid').setView([51.505, -0.09], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
		}).addTo(mymap);

		// Erstellen Sie eine Gruppe für Ihre Marker
		var markers = L.layerGroup().addTo(mymap);

		// Fügen Sie Marker zur Gruppe hinzu
		var berlin = L.marker([52.5200, 13.4050]);
		markers.addLayer(berlin);
		berlin.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

		function search() {
			var query = document.getElementById("search-box").value;
			var url = "https://nominatim.openstreetmap.org/search?q=" + query + "&format=json&addressdetails=1&limit=1&limit=1&countrycodes=de";
			fetch(url)
				.then(response => response.json())
				.then(data => {
					var lat = data[0].lat;
					var lon = data[0].lon;
					mymap.setView([lat, lon], 10);
					var cityUrl = "https://nominatim.openstreetmap.org/search.php?q=" + query + "&polygon_geojson=1&format=geojson&limit=1&countrycodes=de";
					fetch(cityUrl)
						.then(response => response.json())
						.then(data => {
						var bounds = L.geoJSON(data).getBounds();
						mymap.fitBounds(bounds);

						// Entfernen Sie alle Marker, die nicht innerhalb der Grenzen liegen
						markers.eachLayer(function (marker) {
							if (!bounds.contains(marker.getLatLng())) {
								markers.removeLayer(marker);
							}
						});

              			// todo: Das Alte soll noch gelöscht werden vor jeder suchanfrage

						L.geoJSON(data, {
							style: function(feature) {
								return {
									fillColor: '#3388ff',
									fillOpacity: 0.4,
									color: '#3388ff',
									weight: 2
								};
						}}).addTo(mymap);
					}).catch(error => console.error(error));		
			}).catch(error => console.error(error));
		}
	</script>
</body>
</html>